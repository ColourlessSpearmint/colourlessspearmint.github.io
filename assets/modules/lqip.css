/* === LQIP (CSS-only Low Quality Image Placeholder) === */
/* Decode and render a CSS-only LQIP when the element has --lqip set */
[style*="--lqip:"] {
  /* --- unpack 20 bits into named numeric components --- */
  --lqip-ca: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 18))), 4);
  --lqip-cb: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 16))), 4);
  --lqip-cc: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 14))), 4);
  --lqip-cd: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 12))), 4);
  --lqip-ce: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 10))), 4);
  --lqip-cf: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 8))), 4);

  --lqip-ll: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 6))), 4);
  --lqip-aaa: mod(round(down, calc((var(--lqip) + pow(2, 19)) / pow(2, 3))), 8);
  --lqip-bbb: mod(calc(var(--lqip) + pow(2, 19)), 8);

  /* --- map numeric components to colors --- */
  /* grayscale component -> monochrome HSL with lightness from 20%..80% */
  --lqip-ca-clr: hsl(0 0% calc(var(--lqip-ca) / 3 * 60% + 20%));
  --lqip-cb-clr: hsl(0 0% calc(var(--lqip-cb) / 3 * 60% + 20%));
  --lqip-cc-clr: hsl(0 0% calc(var(--lqip-cc) / 3 * 60% + 20%));
  --lqip-cd-clr: hsl(0 0% calc(var(--lqip-cd) / 3 * 60% + 20%));
  --lqip-ce-clr: hsl(0 0% calc(var(--lqip-ce) / 3 * 60% + 20%));
  --lqip-cf-clr: hsl(0 0% calc(var(--lqip-cf) / 3 * 60% + 20%));

  /* base colour in Oklab using the decoded L, a, b ranges from the article */
  --lqip-base-clr: oklab(
    calc(var(--lqip-ll) / 3 * 0.6 + 0.2)
    calc(var(--lqip-aaa) / 8 * 0.7 - 0.35)
    calc((var(--lqip-bbb) + 1) / 8 * 0.7 - 0.35)
  );

  /* --- renderer: stacked radial gradients (3x2) then flat base colour at the bottom --- */
  background-image:
    radial-gradient(50% 75% at 16.6667% 25%, var(--lqip-ca-clr), transparent),
    radial-gradient(50% 75% at 50%      25%, var(--lqip-cb-clr), transparent),
    radial-gradient(50% 75% at 83.3333% 25%, var(--lqip-cc-clr), transparent),
    radial-gradient(50% 75% at 16.6667% 75%, var(--lqip-cd-clr), transparent),
    radial-gradient(50% 75% at 50%      75%, var(--lqip-ce-clr), transparent),
    radial-gradient(50% 75% at 83.3333% 75%, var(--lqip-cf-clr), transparent),
    linear-gradient(0deg, var(--lqip-base-clr), var(--lqip-base-clr));

  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
