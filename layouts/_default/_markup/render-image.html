{{ $destination := replace (.Destination | safeURL) "~/" "/media/" }}
{{ $img := resources.Get $destination }}
{{ $src := $img.RelPermalink }}

{{ $width := "" }}
{{ $height := "" }}
{{ if and $img (eq $img.MediaType.MainType "image") (ne $img.MediaType.SubType "svg") }}
    {{ $width = $img.Width }}
    {{ $height = $img.Height }}
{{ end }}

{{ $alt := .PlainText }}
{{ $is_video := or (strings.HasSuffix $src ".webm") (strings.HasSuffix $src ".mp4") (strings.HasSuffix $src ".ogg") (strings.HasSuffix $src ".mov") }}
{{ $is_gif := findRE "GIF" $alt }}
{{ $is_verytall := findRE "TALL" $alt }}
{{ $alt_processed := $alt }}
{{ $alt_processed = replace $alt_processed "GIF" ""}}
{{ $alt_processed = replace $alt_processed "TALL" ""}}

{{ $verytall := "" }}
{{ if $is_verytall }}
{{ $verytall = "media-verytall" }}
{{ end }}

<figure>
    {{ if $is_video }}
    {{ if $is_gif }}
    <video
        class="content-media gif {{ $verytall }}"
        src="{{ $src }}"
        alt="{{ $alt_processed }}"
        autoplay
        loop
        muted
        playsinline
    ></video>
    {{ else }}
    <video
        class="content-media video {{ $verytall }}"
        src="{{ $src }}"
        alt="{{ $alt_processed }}"
        controls
    ></video>
    {{ end }}
    {{ else }}
    <img
        class="content-media {{ $verytall }}"
        src="{{ $src }}"
        alt="{{ $alt_processed }}"
        {{ if $width }}width="{{ $width }}"{{ end }}
        {{ if $height }}height="{{ $height }}"{{ end }}
    />
    {{ end }}
    {{- with .Title }}
    <figcaption>{{ . }}</figcaption>
    {{ end -}}
</figure>
